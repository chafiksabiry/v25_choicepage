<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Choice Page</title>
    
    <!-- Debug logging setup -->
    <script type="text/javascript">
      window.debug = (...args) => console.log('[Debug]', ...args);
      window.debug('Starting application load');
    </script>

    <!-- Load dependencies in order -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-router-dom@6/dist/umd/react-router-dom.production.min.js" crossorigin></script>
    
    <!-- SystemJS core -->
    <script src="https://cdn.jsdelivr.net/npm/systemjs@6.8.3/dist/system.js"></script>
    
    <script type="text/javascript">
      // Error handler
      window.addEventListener('error', function(event) {
        console.error('[Error Event]', {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error
        });
      });

      // Initialize SystemJS
      function initializeSystem() {
        window.debug('Initializing SystemJS');
        
        // Verify SystemJS is loaded
        if (typeof System === 'undefined') {
          throw new Error('SystemJS not loaded');
        }

        if (typeof System.config !== 'function') {
          throw new Error('SystemJS.config not available');
        }

        // Configure SystemJS
        System.config({
          baseURL: window.__POWERED_BY_QIANKUN__ ? '/app2' : '/choicepage',
          defaultExtension: 'js',
          meta: {
            '*.js': {
              format: 'system',
              babelOptions: {
                es2015: false
              }
            }
          },
          packages: {
            '/': {
              defaultExtension: 'js'
            }
          }
        });

        // Map external dependencies
        const externals = {
          'react': window.React,
          'react-dom': window.ReactDOM,
          'react-router-dom': window.ReactRouterDOM
        };

        Object.entries(externals).forEach(([name, module]) => {
          if (!module) {
            console.warn(`External dependency ${name} not found`);
            return;
          }
          System.set(name, System.newModule(module));
        });

        window.debug('SystemJS initialized successfully');
        return true;
      }

      // Load the application
      function loadApplication() {
        if (!window.__POWERED_BY_QIANKUN__) {
          window.debug('Loading application in standalone mode');
          const mainScript = '/choicepage/assets/main.js';
          
          // First verify the script exists
          fetch(mainScript, { 
            method: 'HEAD',
            headers: {
              'Accept': 'application/javascript'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            window.debug('Main script verified, proceeding with import');
            return System.import(mainScript);
          })
          .then(() => {
            window.debug('Application loaded successfully');
          })
          .catch(error => {
            console.error('Failed to load application:', error);
            // Try to provide more detailed error information
            if (error.stack) {
              console.error('Error stack:', error.stack);
            }
          });
        } else {
          window.debug('Running in Qiankun mode');
        }
      }

      // Main initialization
      function initialize() {
        try {
          if (initializeSystem()) {
            loadApplication();
          }
        } catch (error) {
          console.error('Initialization failed:', error);
        }
      }

      // Wait for all scripts to load
      window.addEventListener('load', function() {
        window.debug('Window load event fired');
        setTimeout(initialize, 100); // Small delay to ensure everything is ready
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>